<!DOCTYPE html>
<html>
	<head>
		<title>Beep boop</title>
		<style>
			#app {
				display: flex;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<select v-model="selectedDataset">
				<option v-for="dataset in datasets" v-bind:value="dataset">{{ dataset.name }}</option>
			</select>

			<div class="sample">
				<table>
					<tr v-for="(entry, i) in sample" v-bind:key="i">
						<td v-for="(text, lang) in entry" v-bind:key="lang" v-bind:lang="lang">{{text}}</td>
					</tr>
				</table>
			</div>

			<div class="filters">
				<ul class="available-filters">
					<li v-for="(filter, name) in filters">
						<span v-bind:title="filter.command">{{name}}</span>
						<button v-on:click="addFilterStep(name, filter)">Add</button>
					</li>
				</ul>

				<ol class="filter-steps">
					<li v-for="(filterStep, i) in filterSteps">
						<span>{{ filterStep.filter }}</span>
						<button v-on:click="removeFilterStep(i)">Remove</button>
					</li>
				</ol>
			</div>
		</div>
		<!-- because Safari, unfortunately, does not do importmap yet? -->
		<script async src="https://ga.jspm.io/npm:es-module-shims@1.5.8/dist/es-module-shims.js"></script>
		<script type="importmap">
			{
				"imports": {
					"vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
				}
			}
		</script>
		<script type="module">
			import {createApp} from 'vue';

			createApp({
				data() {
					return {
						datasets: [],
						selectedDataset: null,
						sample: [],
						filters: [],
						filterSteps: []
					};
				},

				async mounted() {
					this.reloadDatasets();
					this.reloadFilters();
				},

				watch: {
					selectedDataset() {
						this.reloadSample();
					},
					filterSteps: {
						deep: true,
						handler() {
							this.reloadSample()
						}
					}
				},

				methods: {
					async reloadDatasets() {
						const response = await fetch('/datasets/');
						this.datasets = await response.json();
					},
					async reloadFilters() {
						const response = await fetch('/filters/');
						this.filters = await response.json();
					},
					async reloadSample() {
						const response = await fetch(`/datasets/${encodeURIComponent(this.selectedDataset.name)}/sample`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Accept': 'application/json',
							},
							body: JSON.stringify(this.filterSteps)
						});
						this.sample = await response.json();
					},
					addFilterStep(name, filter) {
						this.filterSteps.push({
							filter: name,
							parameters: {}
						})
					},
					removeFilterStep(i) {
						this.filterSteps.splice(i);
					}
				},
			}).mount('#app');
		</script>
	</body>
</html>