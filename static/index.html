<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Empty Train</title>
		<style>
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
				overflow: hidden;
			}

			body {
				font: 16px/24px sans-serif;
			}

			#app {
				height: 100%;
				display: flex;
				flex-direction: column;
			}

			.controls {
				flex: 0;
				border-bottom: 1px solid #ccc;
			}

			.main {
				flex: 1;
				display: flex;
				overflow: hidden;
			}

			.filter-output {
				display: flex;
				flex-direction: column;
				flex: 1 1 auto;
/*				overflow: hidden;*/
			}

			.filter-error {
				border-top: 1px solid #ccc;
				flex: 0 0 auto;
				overflow: hidden;
				overflow-y: auto;
			}

			.filter-error pre {
				white-space: pre-wrap;
			}

			.sample {
				flex: 1 1 auto;
				overflow-y: auto;
			}

			.sample table {
				table-layout: fixed;
			}

			.sample table td {
				width: 50%;
			}

			.sample.display-as-rows table thead {
				display: none;
			}

			.sample.display-as-rows table tr {
				display: block;
				margin-bottom: 1em;
			}

			.sample.display-as-rows table td {
				display: block;
				width: auto;
			}

			.sample.display-as-rows td[lang]::before {
				content: attr(lang) ': ';
				display: inline-block;
				margin: 0 0.5em 0 0;
				opacity: 0.5;
			}

			.filters {
				display: flex;
				flex-direction: column;
				flex: 0 0 300px;
				border-left: 1px solid #ccc;
			}

			.available-filters {
				flex: 0;
			}

			.filter-steps {
				flex: 1;
				border-top: 1px solid #ccc;
				overflow-y: auto;
			}

			.filter {
				display: flex;
			}

			.filter .filter-name {
				flex: 2;
			}

			.filter .filter-type {
				flex: 1;
				font-size: 0.8em;
				padding-left: 0.5em;
			}

			.filter .add-filter-btn {
				flex: 0;
				align-self: center;
			}

			.filter-steps li {
				background: #ccc;
				border-radius: 4px;
				padding: 0.5em;
				margin: 0 0 1em 0;
			}

			.filter-steps label {
				display: block;
			}

			.controls, .available-filters, .filter-steps {
				margin: 0;
				padding: 0.5em 1em;
				list-style: none;
			}
		</style>
	</head>
	<body>
		<div id="app">
			<div class="controls">
				<label>
					Dataset:
					<select v-model="selectedDataset">
						<option v-for="dataset in datasets" v-bind:value="dataset">{{ dataset.name }}</option>
					</select>
				</label>

				<label>
					<input type="checkbox" v-model="displayAsRows">
					Display as rows
				</label>

				<button v-on:click="saveFilterSteps" v-bind:disabled="!filterStepsChangedSinceLastSave">Save filtering steps</button>
			</div>

			<div class="main">
				<div class="filter-output">
					<div v-bind:class="{'sample':true, 'display-as-rows': displayAsRows}">
						<table>
							<thead>
								<tr>
									<th v-for="lang in languages">{{lang}}</th>
								</tr>
							</thead>
							<tbody>
								<tr v-for="(entry, i) in sample.stdout" v-bind:key="i">
									<td v-for="(text, lang) in entry" v-bind:key="lang" v-bind:lang="lang">{{text}}</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="filter-error" v-if="sample.stderr">
						<pre>{{ sample.stderr }}</pre>
					</div>
				</div>

				<div class="filters">
					<ul class="available-filters">
						<li v-for="(filter, name) in filters" class="filter">
							<span v-bind:title="filter.description" class="filter-name">{{name}}</span>
							<span class="filter-type">{{filter.type}}</span>
							<button v-on:click="addFilterStep(name, filter)" class="add-filter-btn">Add</button>
						</li>
					</ul>

					<ol class="filter-steps">
						<li v-for="(filterStep, i) in filterSteps">
							<span>{{ filterStep.filter }}</span>
							<label>
								<span>Column</span>
								<select v-if="filterRequiresLanguage(filterStep)" v-model="filterStep.language">
									<option v-for="lang in languages">{{lang}}</option>
								</select>
							</label>
							<label v-for="(parameter, name) in filterDefinition(filterStep).parameters">
								<span>{{ name }}</span>
								<select v-if="parameter.type == 'str' && parameter.allowed_values" v-model="filterStep.parameters[name]">
									<option v-for="value in parameter.allowed_values" v-bind:value="value">{{value}}</option>
								</select>
								<input v-else-if="parameter.type == 'bool'" type="checkbox" v-model="filterStep.parameters[name]">
								<input v-else-if="parameter.type == 'int' || parameter.type == 'float'"
									type="number"
									v-model="filterStep.parameters[name]"
									v-bind:min="parameter.min"
									v-bind:max="parameter.max"
									v-bind:step="parameter.type == 'int' ? 1 : 0.1">
								<input v-else type="text" v-model="filterStep.parameters[name]">
								
								<small v-if="parameter.help">{{parameter.help}}</small>
							</label>
							<button v-on:click="removeFilterStep(i)">Remove</button>
						</li>
					</ol>
				</div>
			</div>
		</div>
		<!-- because Safari, unfortunately, does not do importmap yet? -->
		<script async src="https://ga.jspm.io/npm:es-module-shims@1.5.8/dist/es-module-shims.js"></script>
		<script type="importmap">
			{
				"imports": {
					"vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
				}
			}
		</script>
		<script type="module">
			import {createApp} from 'vue';

			function cyrb53(str, seed = 0) {
				let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
				for (let i = 0, ch; i < str.length; i++) {
					ch = str.charCodeAt(i);
					h1 = Math.imul(h1 ^ ch, 2654435761);
					h2 = Math.imul(h2 ^ ch, 1597334677);
				}
				h1 = Math.imul(h1 ^ (h1>>>16), 2246822507) ^ Math.imul(h2 ^ (h2>>>13), 3266489909);
				h2 = Math.imul(h2 ^ (h2>>>16), 2246822507) ^ Math.imul(h1 ^ (h1>>>13), 3266489909);
				return 4294967296 * (2097151 & h2) + (h1>>>0);
			}

			window.$app = createApp({
				data() {
					return {
						displayAsRows: false,
						datasets: [],
						selectedDataset: null,
						sample: [],
						filters: {},
						filterSteps: [],
						filterStepsLastSave: null
					};
				},

				async mounted() {
					this.fetchDatasets();
					this.fetchFilters();
				},

				computed: {
					languages() {
						return this.selectedDataset ? Array.from(Object.keys(this.selectedDataset.columns)).sort() : []
					},
					filterStepsStateHash() {
						return cyrb53(JSON.stringify(this.filterSteps));
					},
					filterStepsChangedSinceLastSave() {
						return this.filterStepsLastSave !== this.filterStepsStateHash;
					}
				},

				watch: {
					selectedDataset() {
						this.fetchSample();
						this.fetchFilterSteps();
					},
					filterSteps: {
						deep: true,
						handler() {
							this.fetchSample()
						}
					}
				},

				methods: {
					async fetchDatasets() {
						const response = await fetch('/datasets/');
						this.datasets = await response.json();
					},
					async fetchFilters() {
						const response = await fetch('/filters/');
						this.filters = await response.json();
					},
					async fetchSample() {
						const response = await fetch(`/datasets/${encodeURIComponent(this.selectedDataset.name)}/sample`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Accept': 'application/json',
							},
							body: JSON.stringify(this.filterSteps)
						});

						if (response.ok)
							this.sample = await response.json();
						else
							this.sample = {stdout: [], stderr: await response.text()};
					},
					async fetchFilterSteps() {
						const response = await fetch(`/datasets/${encodeURIComponent(this.selectedDataset.name)}/configuration`)
						this.filterSteps = await response.json();
						this.filterStepsLastSave = this.filterStepsStateHash;
					},
					async saveFilterSteps() {
						const hash = this.filterStepsStateHash;

						const response = await fetch(`/datasets/${encodeURIComponent(this.selectedDataset.name)}/configuration`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Accept': 'application/json'
							},
							body: JSON.stringify(this.filterSteps)
						});

						if (response.ok)
							this.filterStepsLastSave = hash;
						else
							alert(await response.text());
					},
					addFilterStep(name, filter) {
						this.filterSteps.push({
							filter: name,
							language: this.filterRequiresLanguage({filter:name}) ? this.languages[0] : null,
							parameters: Object.fromEntries(Object.entries(filter.parameters).map(([key, parameter]) => [key, parameter.default]))
						});
					},
					removeFilterStep(i) {
						this.filterSteps.splice(i);
					},
					filterDefinition(filterStep) {
						return this.filters[filterStep.filter];
					},
					filterRequiresLanguage(filterStep) {
						return this.filterDefinition(filterStep).type == 'monolingual';
					},
				},
			}).mount('#app');
		</script>
	</body>
</html>